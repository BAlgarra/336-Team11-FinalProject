<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Browse Issues</title>

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
    <link href="/css/styles.css" rel="stylesheet" />
    <link rel="icon" type="image/png" href="/img/comicFavIcon.png" />
  </head>

  <body class="browseBody">
    <%- include('partials/header.ejs') %>
    <%- include('partials/navbar.ejs') %>

    <div class="container mt-4">
      <div class="row">
        <% for (let i = 0; i < issueData.length; i++) { %>
        <div class="col-6 col-md-3 mb-4">
          <!-- Comic Card -->
          <div class="card shadow-sm">
            <img
              src="<%= issueData[i].image.medium_url %>"
              class="card-img-top"
              role="button"
              data-bs-toggle="modal"
              data-bs-target="#browseModal<%= i %>"
            />

            <div class="card-body">
              <h5 class="card-title">
                <%= issueData[i].name || `Issue #${issueData[i].issue_number}` %>
              </h5>
            </div>
          </div>
        </div>

        <!-- Modal -->
        <div
          class="modal fade"
          id="browseModal<%= i %>"
          tabindex="-1"
          aria-hidden="true"
        >
          <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
              
              <!-- Modal Header -->
              <div class="modal-header">
                <h5 class="modal-title">
                  <%= issueData[i].name || ("Issue #" + issueData[i].issue_number) %>
                </h5>
                <button class="btn-close" data-bs-dismiss="modal"></button>
              </div>

              <!-- Modal Body -->
              <div class="modal-body">
                
                <!-- Image -->
                <div class="text-center mb-3">
                  <img
                    src="<%= issueData[i].image.super_url %>"
                    class="img-fluid rounded"
                    alt="Comic Cover"
                  />
                </div>

                <!-- Comic Info -->
                <div>
                  <p><strong>Issue Number:</strong> <%= issueData[i].issue_number %></p>
                  <p><strong>Volume Name:</strong> <%= issueData[i].volume.name %></p>
                  <p><strong>Volume ID:</strong> <%= issueData[i].volume.id %></p>
                  <p><strong>Cover Date:</strong> <%= issueData[i].cover_date %></p>
                  <p><strong>Store Date:</strong> <%= issueData[i].store_date %></p>

                  <p>
                    <strong>API Detail URL:</strong><br />
                    <a href="<%= issueData[i].api_detail_url %>" target="_blank">
                      <%= issueData[i].api_detail_url %>
                    </a>
                  </p>

                  <p>
                    <strong>Site Detail URL:</strong><br />
                    <a href="<%= issueData[i].site_detail_url %>" target="_blank">
                      <%= issueData[i].site_detail_url %>
                    </a>
                  </p>

                  <hr />

                  <p><strong>Description:</strong></p>
                  <div style="max-height: 200px; overflow-y: auto">
                    <%- issueData[i].description || "<em>No description available.</em>" %>
                  </div>
                </div>

                <hr class="mt-4" />

                <% if (user_id) { %>
                <!-- Add to Collection Form -->
                <form action="/addComicToCollection" method="POST">
                  <input type="hidden" name="comicvine_id" value="<%= issueData[i].id %>" />

                  <div class="mb-2">
                    <label class="form-label"><strong>Select Collection</strong></label>
                    <select class="form-select" name="collection_id" required>
                      <option value="">-- Choose a Collection --</option>
                      <% collections.forEach(col => { %>
                      <option value="<%= col.collection_id %>"><%= col.name %></option>
                      <% }) %>
                    </select>
                  </div>

                  <button type="submit" class="btn btn-primary w-100 mt-2">
                    Add to Collection
                  </button>
                </form>

                <% } else { %>
                <!-- Not logged in message + Login button -->
                <div class="text-center mt-3 pb-2">
                  <p class="text-muted mb-2">
                    <em>Login to add this comic to your collection.</em>
                  </p>
                  <a href="/login" class="btn btn-outline-primary w-50">Login</a>
                </div>
                <% } %>

              </div> <!-- END modal-body -->
              
            </div>
          </div>
        </div>

        <% } %>
      </div>
    </div>

    <div class="nextPagePrevPage mt-4">
      <% if (pageNum > 0) { %>
      <a class="prevButton" href="/browse?page=<%= pageNum - 1 %>">Previous</a>
      <% } %>

      <a class="nextButton" href="/browse?page=<%= Number(pageNum) + 1 %>">Next</a>
    </div>

  </body>
</html>
